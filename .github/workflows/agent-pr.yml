name: Copilot Fix - Auto PR Creation

on:
  repository_dispatch:
    types: [copilot-fix]

jobs:
  create-fix-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract ticket information
        id: ticket
        run: |
          echo "ticket_id=${{ github.event.client_payload.ticket_id }}" >> $GITHUB_OUTPUT
          echo "ticket_summary=${{ github.event.client_payload.ticket_summary }}" >> $GITHUB_OUTPUT
          echo "jira_url=${{ github.event.client_payload.jira_url }}" >> $GITHUB_OUTPUT

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and checkout branch
        run: |
          BRANCH_NAME="fix/${{ steps.ticket.outputs.ticket_id }}"
          echo "Creating branch: $BRANCH_NAME"
          git checkout -b "$BRANCH_NAME"

      - name: Generate HTML file
        run: |
          TICKET_ID="${{ steps.ticket.outputs.ticket_id }}"
          TICKET_SUMMARY="${{ github.event.client_payload.ticket_summary }}"
          TICKET_DESCRIPTION="${{ github.event.client_payload.ticket_description }}"
          JIRA_URL="${{ steps.ticket.outputs.jira_url }}"
          GENERATED_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # Escape HTML special characters in variables
          TICKET_SUMMARY_ESCAPED=$(echo "$TICKET_SUMMARY" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
          TICKET_DESCRIPTION_ESCAPED=$(echo "$TICKET_DESCRIPTION" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')

          # Generate HTML file directly with variables
          cat > "${TICKET_ID}.html" << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>${TICKET_ID} - Fix</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      line-height: 1.6;
                      background-color: #f5f5f5;
                  }
                  .container {
                      background: white;
                      padding: 40px;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  h1 {
                      color: #0052CC;
                      border-bottom: 3px solid #0052CC;
                      padding-bottom: 10px;
                  }
                  .meta {
                      background: #f4f5f7;
                      padding: 15px;
                      border-radius: 4px;
                      margin: 20px 0;
                  }
                  .description {
                      margin-top: 20px;
                  }
                  a {
                      color: #0052CC;
                      text-decoration: none;
                  }
                  a:hover {
                      text-decoration: underline;
                  }
                  .badge {
                      display: inline-block;
                      background: #00875A;
                      color: white;
                      padding: 4px 12px;
                      border-radius: 12px;
                      font-size: 14px;
                      font-weight: bold;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <span class="badge">COPILOT-FIX</span>
                  <h1>${TICKET_ID}</h1>

                  <div class="meta">
                      <strong>Summary:</strong> ${TICKET_SUMMARY_ESCAPED}<br>
                      <strong>JIRA Link:</strong> <a href="${JIRA_URL}" target="_blank">${JIRA_URL}</a><br>
                      <strong>Generated:</strong> ${GENERATED_TIME}
                  </div>

                  <div class="description">
                      <h2>Description</h2>
                      <p>${TICKET_DESCRIPTION_ESCAPED}</p>
                  </div>

                  <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">

                  <p style="color: #666; font-size: 14px;">
                      This file was automatically generated by the Copilot Fix Bridge automation.
                  </p>
              </div>
          </body>
          </html>
          EOF

          echo "Generated ${TICKET_ID}.html"
          echo "File size: $(wc -c < "${TICKET_ID}.html") bytes"

      - name: Commit changes
        run: |
          TICKET_ID="${{ steps.ticket.outputs.ticket_id }}"
          git add "${TICKET_ID}.html"
          git commit -m "fix: Auto-generated fix for ${TICKET_ID}

          JIRA Ticket: ${{ steps.ticket.outputs.jira_url }}
          Summary: ${{ github.event.client_payload.ticket_summary }}

          Generated automatically by Copilot Fix Bridge"

      - name: Push branch
        run: |
          BRANCH_NAME="fix/${{ steps.ticket.outputs.ticket_id }}"
          git push origin "$BRANCH_NAME"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: fix/${{ steps.ticket.outputs.ticket_id }}
          title: "fix: ${{ steps.ticket.outputs.ticket_id }} - ${{ github.event.client_payload.ticket_summary }}"
          body: |
            ## JIRA Ticket: ${{ steps.ticket.outputs.ticket_id }}

            **Summary:** ${{ github.event.client_payload.ticket_summary }}

            **JIRA Link:** [${{ steps.ticket.outputs.ticket_id }}](${{ steps.ticket.outputs.jira_url }})

            ---

            ### Description
            ${{ github.event.client_payload.ticket_description }}

            ---

            ### Changes
            - Generated HTML file: `${{ steps.ticket.outputs.ticket_id }}.html`
            - Contains ticket ID and description as requested

            ---

            **Automated PR created by Copilot Fix Bridge**
          labels: |
            copilot-fix
            automated
          draft: false
