name: Copilot Fix - Auto PR Creation

on:
  repository_dispatch:
    types: [copilot-fix]

jobs:
  create-fix-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Extract ticket information
        id: ticket
        run: |
          echo "ticket_id=${{ github.event.client_payload.ticket_id }}" >> $GITHUB_OUTPUT
          echo "ticket_summary=${{ github.event.client_payload.ticket_summary }}" >> $GITHUB_OUTPUT
          echo "jira_url=${{ github.event.client_payload.jira_url }}" >> $GITHUB_OUTPUT

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Ensure we're on latest main and create branch
        run: |
          # Fetch latest changes
          git fetch origin main

          # Reset to latest main
          git checkout main
          git reset --hard origin/main

          # Delete remote branch if it exists (cleanup from previous failed runs)
          BRANCH_NAME="fix/${{ steps.ticket.outputs.ticket_id }}"
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || echo "Branch doesn't exist remotely, continuing..."

          # Create and checkout new branch from latest main
          echo "Creating branch: $BRANCH_NAME from latest main"
          git checkout -b "$BRANCH_NAME"

      - name: Generate HTML file
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import html
          from datetime import datetime

          # Get variables from environment
          ticket_id = "${{ steps.ticket.outputs.ticket_id }}"
          ticket_summary = """${{ github.event.client_payload.ticket_summary }}"""
          ticket_description = """${{ github.event.client_payload.ticket_description }}"""
          jira_url = "${{ steps.ticket.outputs.jira_url }}"
          generated_time = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")

          # Escape HTML special characters
          ticket_summary_safe = html.escape(ticket_summary)
          ticket_description_safe = html.escape(ticket_description)

          # Generate HTML content
          html_content = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>{ticket_id} - Fix</title>
              <style>
                  body {{
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      line-height: 1.6;
                      background-color: #f5f5f5;
                  }}
                  .container {{
                      background: white;
                      padding: 40px;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }}
                  h1 {{
                      color: #0052CC;
                      border-bottom: 3px solid #0052CC;
                      padding-bottom: 10px;
                  }}
                  .meta {{
                      background: #f4f5f7;
                      padding: 15px;
                      border-radius: 4px;
                      margin: 20px 0;
                  }}
                  .description {{
                      margin-top: 20px;
                      white-space: pre-wrap;
                  }}
                  a {{
                      color: #0052CC;
                      text-decoration: none;
                  }}
                  a:hover {{
                      text-decoration: underline;
                  }}
                  .badge {{
                      display: inline-block;
                      background: #00875A;
                      color: white;
                      padding: 4px 12px;
                      border-radius: 12px;
                      font-size: 14px;
                      font-weight: bold;
                  }}
              </style>
          </head>
          <body>
              <div class="container">
                  <span class="badge">COPILOT-FIX</span>
                  <h1>{ticket_id}</h1>

                  <div class="meta">
                      <strong>Summary:</strong> {ticket_summary_safe}<br>
                      <strong>JIRA Link:</strong> <a href="{jira_url}" target="_blank">{jira_url}</a><br>
                      <strong>Generated:</strong> {generated_time}
                  </div>

                  <div class="description">
                      <h2>Description</h2>
                      <p>{ticket_description_safe}</p>
                  </div>

                  <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">

                  <p style="color: #666; font-size: 14px;">
                      This file was automatically generated by the Copilot Fix Bridge automation.
                  </p>
              </div>
          </body>
          </html>"""

          # Write to file
          filename = f"{ticket_id}.html"
          with open(filename, 'w', encoding='utf-8') as f:
              f.write(html_content)

          print(f"Generated {filename}")
          print(f"File size: {os.path.getsize(filename)} bytes")
          PYTHON_SCRIPT

      - name: Commit changes
        run: |
          TICKET_ID="${{ steps.ticket.outputs.ticket_id }}"
          git add "${TICKET_ID}.html"
          git commit -m "fix: Auto-generated fix for ${TICKET_ID}

          JIRA Ticket: ${{ steps.ticket.outputs.jira_url }}
          Summary: ${{ github.event.client_payload.ticket_summary }}

          Generated automatically by Copilot Fix Bridge"

      - name: Push branch
        run: |
          BRANCH_NAME="fix/${{ steps.ticket.outputs.ticket_id }}"
          git push -u origin "$BRANCH_NAME"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        run: |
          TICKET_ID="${{ steps.ticket.outputs.ticket_id }}"
          TICKET_SUMMARY="${{ github.event.client_payload.ticket_summary }}"
          TICKET_DESCRIPTION="${{ github.event.client_payload.ticket_description }}"
          JIRA_URL="${{ steps.ticket.outputs.jira_url }}"

          gh pr create \
            --title "fix: ${TICKET_ID} - ${TICKET_SUMMARY}" \
            --body "## JIRA Ticket: ${TICKET_ID}

          **Summary:** ${TICKET_SUMMARY}

          **JIRA Link:** [${TICKET_ID}](${JIRA_URL})

          ---

          ### Description
          ${TICKET_DESCRIPTION}

          ---

          ### Changes
          - Generated HTML file: \`${TICKET_ID}.html\`
          - Contains ticket ID and description as requested

          ---

          ðŸ¤– **Automated PR created by Copilot Fix Bridge**" \
            --base main \
            --head "fix/${TICKET_ID}"

          # Add labels if they exist (ignore errors if they don't)
          gh pr edit "fix/${TICKET_ID}" --add-label "copilot-fix,automated" 2>/dev/null || echo "Labels not found, skipping..."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
